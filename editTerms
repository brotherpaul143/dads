#!/usr/bin/perl -w
$versionRCS='$Header: /home/black/DADS/dads/RCS/editTerms,v 1.14 2013/10/01 13:36:05 black Exp $';
#	      *created  "Wed Oct 15 10:37:48 2003" *by "Paul E. Black"
$versionMod=' *modified "Mon Sep  9 13:54:44 2013" *by "Paul E. Black"';

#-----------------------------------------------------------------------------
#
# Check out, change, and check in terms
#
$useMsg = "use: editTerms [--help] [--version] [--force] *.trm";
$minOperands = 1;
$typUse = "./editTerms `grep -l vertices Terms/*.trm`";
#
# This software was developed at the National Institute of Standards 
# and Technology by employees of the Federal Government in the course 
# of their official duties.  Pursuant to title 17 Section 105 of the 
# United States Code this software is not subject to copyright 
# protection and is in the public domain. 
# 
# We would appreciate acknowledgment if the software is used.
#
# Paul E. Black  paul.black@nist.gov or p.black@acm.org
#	http://hissa.nist.gov/~black/
#
#-----------------------------------------------------------------------------

#------------------------------------------------------------------------------
#	Command line handling
#------------------------------------------------------------------------------

$reason = "update URL for Aaronson's Complexity Zoo";
#           search for SPECIFIC EDIT
$editor = "Paul E. Black"; # for *modified line
# check that hard-coded date is current to reduce chance of 
# using old reason and old edits
$checkDate = 1;

while ($#ARGV >= 0) {
    if ($ARGV[0] =~ /^--?h(e(lp?)?)?/) {
	print "$useMsg\n";
	print "    where\n";
	print "\t--version Print version and exit\n";
	print "\t--help    Print this message and exit\n";
	print "\t--force   Check out, etc. even though date differs\n";
	print "\t--        End of options (e.g., term begins with -)\n";
	print "    Check out and edit each file.  Do rcsdiff, so you can review changes, and\n";
	print "    ask if you want to commit them.  Your options are:\n";
	print "\ty - Yes; check in changes, with this \"reason\":\n";
	print "\t\t$reason\n";
	print "\tl - Leave changes, but don't check in\n";
	print "\tn - No; unlock the file and revert to the previous version\n";
	print "\tq - Quit; unlock the file and revert, then quit\n";
	print "    The default is 'n'.\n";
	print "typical use:\n";
	print "    $typUse\n";
	exit 0;
    } elsif ($ARGV[0] =~ /^--?v(e(r(s(i(on?)?)?)?)?)?$/) {
	print "$versionRCS\n";
	print "$versionMod\n";
	exit 0;
    } elsif ($ARGV[0] =~ /^--?f(o(r(ce?)?)?)?$/) {
	$checkDate = 0;
	print "Check in reason is '$reason'\n";
	shift;
    } elsif ($ARGV[0] eq "--") {
	shift;
	last;
    } elsif ($ARGV[0] =~ /^-/) {
	print "unknown option: $ARGV[0]\n";
	print "$useMsg\n";
	exit 1;
    } else {
	# end of options
	last;
    }
}

$numberOfOperands = 1 + $#ARGV;
if ($numberOfOperands < $minOperands) {
    print "Wrong number of operands\n";
    print "$useMsg\n";
    die;
}

#------------------------------------------------------------------------------
#	program proper
#------------------------------------------------------------------------------

# make sure the program is not accidentally rerun without being updated
if ($checkDate && localtime() !~ /Mon Sep  9/) {
    print "The (hard coded) check-in reason is:\n";
    print "\t$reason\n";
    print "REMEMBER TO CHANGE THE CHECK-IN REASON!\n";
    print "\tIt is now " . localtime();
    print "\nThe local time does not match\n";
    die;
}

foreach $term_file_name (@ARGV) {
    #print "==} $term_file_name\n";

    # make sure the writable file is the same as the latest RCS version
    system "rcsdiff $term_file_name > /dev/null 2>&1";
    if ($?) {
	print "$term_file_name differs from RCS version; skipping!\n";
	next;
    }

    # (try to) check it out: lock & get writable file
    system "echo n | co -l $term_file_name > /dev/null 2>&1";
    if ($?) {
	print "Could not check out $term_file_name; skipping!\n";
	next;
    }

    # edit the term file in place
    if (open TERM, "< $term_file_name") {
	# read whole file
	@term_contents = <TERM>;

	close TERM || print "Cannot close TERM!?!\n";

	#print `ls -l $term_file_name`;

	# write back an edited version
	$runtime = localtime();
	if (open TERM, "> $term_file_name") {
	    foreach $line (@term_contents) {
		# change *modified
		$line =~ s/[*]modified "[^"]*" [*]by "[^"]*"/*modified "$runtime" *by "$editor"/;

		#----------------------------------------------------
		#	Standard "clean-up" edits
		#----------------------------------------------------

		# fix comment: AKA {cross refs} break autogenerated entries
		$line =~ s/pure names or {cross refs}/pure names/;

		# other clean-up edits
		$line =~ s/HREF=/href=/g;
		$line =~ s|<A|<a|g;
		$line =~ s|</A>|</a>|g;
		$line =~ s|<BR>|<br />|gi;
		$line =~ s|<IMG|<img|g;
		$line =~ s|<LI>|<li>|g;
		$line =~ s|P>|p>|g;
		$line =~ s|PRE>|pre>|g;
		$line =~ s|SUP>|sup>|g;
		$line =~ s|TD>|td>|g;
		$line =~ s|<TD|<td|g;
		$line =~ s|TH>|th>|g;
		$line =~ s|<TR|<tr|g;

		#----------------------------------------------------
		#
		#	HERE IS THE SPECIFIC EDIT(S) WE WANT
		#
		# Remember to change the check-in reason
		#
		#----------------------------------------------------

		$line =~ s|http://qwiki.stanford.edu/index.php/|https://complexityzoo.uwaterloo.ca/|g;

		print TERM $line;
	    }

	    close TERM || print "Cannot close TERM after writing!?!\n";
	} else {
	    print "Cannot open $term_file_name to write!?!\n";
	}
    } else {
	print "Cannot open $term_file_name!?!\n";
    }

    # review any changes
    system "rcsdiff $term_file_name";

    while (1) {
	print "Commit (check in)? [ynhlq](n): ";
	$ans = <STDIN>;
	if ($ans =~ /[ynlq]/i || $ans =~ /^$/) {
	    last;
	} else {
	    print "Yes: check in; Leave edits but don't check in; Help: show this message\n";
	    print "No: unlock and revert; Quit: unlock and revert then exit\n";
	}
    } 
    if ($ans =~ /[y]/i) {
	system("echo \"$reason\" | ci -u $term_file_name");
    } elsif ($ans =~ /[l]/i) {
	print "leaving edits as is and locked.  Remember to check in $term_file_name\n";
    } else {
	# (try to) UNLOCK it
	system "echo n | rcs -u $term_file_name";

	# revert
	system "co -f $term_file_name";
    }

    if ($ans =~ /[q]/i) {
	exit;
    }
}

# end of $Source: /home/black/DADS/dads/RCS/editTerms,v $
